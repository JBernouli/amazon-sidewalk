# PDP initialization and provisioning scripts


## Introduction

The goal of PDP scripts is to facilitate production device provisioning by providing ready-to-use scripts and a way of communicating with the embedded device from a host computer. The PDP flow for development and manufacturing setups stays identical which makes the transition from development to manufacturing transparent.

Scrips consist of two functionalities: initialization and provisioning. Initialization script generates an image with the static portion of a sidewalk certificate (common part of sidewalk certificate) and optionally a sidewalk application. The generated image is identical to all the devices in question.

Provisioning script, on the other hand, flashes the initialization image generated in the previous step (if provided), flashes the production device provisioner application on the RAM memory and provisions device specific information via this application. Each device is provisioned with its a unique set of dynamic data (device specific portion of sidewalk certificate).

## Use cases

### One-stage production

Initialization image flashing and provisioning operations are done on the same manufacturing line. In this case, `--sid-init-img` parameter has to be provided to the provisioning script.

Masserase takes place automatically before the process to ensure that the device is blank before the entire operation.

### Two-stage production

Initialization image is flashed onto the device(s) prior to the provisioning operation (possibly on a different manufacturing line). `--sid-init-img` parameter has to be omitted. This method is recommended for the manufacturing flows where the flashing of the initialization image is separated from the provisioning operation (ie: to decrease the cost of flashing by contract manufacturing while keeping the provisioning operation secure on the premises).

Masserase does not take place automatically before the provisioning to ensure that the previously flashed device flash is not erased.

> Initialization then provisioning order is crucial. If the order is inversed, initialization image will overwrite the provisioning data and the device will be unoperable.

## PDP Modes

### Private key provisioning

Device certificate is generated outside of the device so it is intrinsically less secure. Amazon's signing server tool generates device certificates using OpenSSL and YubiHSM.

Amazon's prototype and production certificate format is not exactly the same so certificate type (prototype or production) has to be provided to the scripts.

Here is an overview of what is happening in this mode:

1. All dynamic data is sent to the device
2. ED25519 and P256R1 device private keys are injected into the secure vault

### On-device certificate generation

Device certificate is generated on the device so it is intrinsically more secure. Amazon's signing server tool signs certificate signing requests (CSRs) with the private key stored in YubiHSM.

Here is an overview of what is happening in this mode:

1. On-device certificate generation module is initialized
2. SMSN is generated by the device and returned to the script
3. ED25519 key pair is generated by the device
4. CSR for ED25519 is generated by the device and returned to the script as certificate generation input
5. P256R1 key pair is generated by the device
6. CSR for P256R1 is generated by the device and returned to the script as certificate generation input
7. ED25519 and P256R1 certificates are generated by the script and returned to the device
8. Application server public key is sent to the device
9. On-device certificate generation module is finalized

## Usage

### Private key provisioning

#### Prototype certificate type

```
python3 initialize_silabs.py --sid-cert </path/to/WirelessDevice.json> --sid-cert-type proto --sid-dev-prof </path/to/DeviceProfile.json> --part <part> --sid-usr-app-img </path/to/user/sid/app.s37> --pdp-mode priv_key_prov
```

```
python3 provision_silabs.py --sid-cert </path/to/WirelessDevice.json> --sid-cert-type proto --part <part> --sid-init-img out/sid_init_img.s37 --pdp-img </path/to/pdp/app.s37> --pdp-mode priv_key_prov
```

#### Production certificate type

```
python3 initialize_silabs.py --sid-cert </path/to/certificate.json> --sid-cert-type prod --part <part> --sid-usr-app-img </path/to/user/sid/app.s37> --pdp-mode priv_key_prov
```

```
python3 provision_silabs.py --sid-cert </path/to/certificate.json> --sid-cert-type prod --part <part> --sid-init-img out/sid_init_img.s37 --pdp-img </path/to/pdp/app.s37> --pdp-mode priv_key_prov
```

### On-device certificate generation

```
python3 initialize_silabs.py --part <part> --sid-usr-app-img </path/to/user/sid/app.s37> --pdp-mode on_dev_cert_gen
```

```
python3 provision_silabs.py --part <part> --sid-init-img out/sid_init_img.s37 --pdp-img </path/to/pdp/app.s37> --dev-type <dev_type_like_A232AX65BNIW2J> --dsn <device_serial_no_like_G6F1JN06119201GP> --apid <advertised_product_id_like_zGhh> --sst-prod-tag <prod_tag_like_RNET_DAK_DUMMY> --sst-hsm-conn-addr <hsm_yubi_connector_addr_like_http://localhost:12345> --sst-hsm-pin <yubi_hsm_pin_like_1234> --app-srv-pub-key <app_srv_pub_key_like_887fc49bb23ffbbdb98550040506c7eddf696707519b0c1c603e4bf8801631c6> --pdp-mode on_dev_cert_gen

or (remaining static production configuration is present in the config file)

python3 provision_silabs.py --pdp-mode on_dev_cert_gen --dsn <device_serial_no_like_G6F1JN06119201GP> --prod-config </path/to/prod_config.json>
```

> **WARNING:** tilde character (~) is not recongnized in the config file so it is recommended to provide absolute file paths for `pdp-img` and `sid-init-img` parameters.

## References

* [Dynamic Data Provisioning Architecture](https://confluence.silabs.com/display/CloudServices/Dynamic+Data+Provisioning+Architecture)
* [Sidewalk Provisioning Architecture](https://confluence.silabs.com/pages/viewpage.action?spaceKey=CloudServices&title=Sidewalk+Provisioning+Architecture)
* [Dynamic data provisioning PoC - v1](https://confluence.silabs.com/display/FLEX/Dynamic+data+provisioning+PoC+-+v1)
* [PDP application](https://confluence.silabs.com/display/FLEX/DDP+application)